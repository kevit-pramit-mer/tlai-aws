#
# OpenSIPS residential configuration script
#     by OpenSIPS Solutions <team@opensips-solutions.com>
#
# This script was generated via "make menuconfig", from
#   the "Residential" scenario.
# You can enable / disable more features / functionalities by
#   re-generating the scenario with different options.#
#
# Please refer to the Core CookBook at:
#      https://opensips.org/Resources/DocsCookbooks
# for a explanation of possible statements, functions and parameters.
#


####### Global Parameters #########

/* uncomment the following lines to enable debugging */
#debug_mode=yes

log_level=3
xlog_level=3
stderror_enabled=no
syslog_enabled=yes
syslog_facility=LOG_LOCAL0
xlog_buf_size = 90000

udp_workers=8


tcp_keepalive=1
tcp_accept_aliases=0
tcp_connection_lifetime=3600
tcp_keepidle=180
tcp_keepinterval=1

/* uncomment the next line to enable the auto temporary blacklisting of
   not available destinations (default disabled) */
#disable_dns_blacklist=no

/* uncomment the next line to enable IPv6 lookup after IPv4 dns
   lookup failures (default disabled) */
#dns_try_ipv6=yes


socket=udp:72.60.40.106:5060 as 72.60.40.106:5060   # CUSTOMIZE ME all opensips ip needs to change
socket=tcp:72.60.40.106:5060 as 72.60.40.106:5060
socket=tls:72.60.40.106:5063 as 72.60.40.106:5063
socket=ws:72.60.40.106:5064  as 72.60.40.106:5064
socket=wss:72.60.40.106:5065 as 72.60.40.106:5065

socket=hep_udp:72.60.40.106:6061
socket=hep_tcp:72.60.40.106:6061
####### Modules Section #####

#set module path
mpath="/usr/local//lib64/opensips/modules/"

#### SIGNALING module
loadmodule "signaling.so"

#### StateLess module
loadmodule "sl.so"

## Proto_udp Module
loadmodule "proto_udp.so"

## Proto_tcp Module
loadmodule "proto_tcp.so"

## MySQL DB Module Load
loadmodule "db_mysql.so"

#### permission module ###
loadmodule "permissions.so"
modparam("permissions", "db_url", "mysql://megh_user:Gv9Xr2mQpLz7KbYt@72.60.40.106/ucdb")

#### Transaction Module
loadmodule "tm.so"
modparam("tm", "fr_timeout", 30)
modparam("tm", "fr_inv_timeout", 100)
modparam("tm", "restart_fr_on_each_reply", 0)
modparam("tm", "onreply_avp_mode", 1)

#### Record Route Module
loadmodule "rr.so"
/* do not append from tag to the RR (no need for this script) */
modparam("rr", "append_fromtag", 0)


######   dialog module  ########
loadmodule "dialog.so"
#modparam("dialog", "db_url", "mysql://megh_user:Gv9Xr2mQpLz7KbYt@72.60.40.106/ucdb")
modparam("dialog", "reinvite_ping_interval", 50)
modparam("dialog", "options_ping_interval", 20)
modparam("dialog", "db_mode", 0)

### avpops Module
loadmodule "avpops.so"

### exec Module
loadmodule "exec.so"

### Proto_WS Module
loadmodule "proto_ws.so"

### proto_tls Module
loadmodule "proto_tls.so"
#modparam("proto_tls", "tls_handshake_timeout", 20000)
#modparam("proto_tls", "tls_send_timeout", 20000)


loadmodule "proto_wss.so"
#modparam("proto_wss", "wss_port", 5065)
#modparam("proto_wss", "require_origin", no)
#modparam("proto_wss", "wss_handshake_timeout", 20000)
#modparam("proto_wss", "wss_tls_handshake_timeout", 20000)


## tls_openssl.so
loadmodule "tls_openssl.so"
## tls_mgm Module
loadmodule "tls_mgm.so"

#modparam("tls_mgm", "tls_library", "wolfssl")

modparam("tls_mgm", "server_domain", "dom1")
#modparam("tls_mgm", "match_ip_address", "[dom1]*")
modparam("tls_mgm", "match_sip_domain", "[dom1]*")
modparam("tls_mgm", "verify_cert", "[dom1]0")
modparam("tls_mgm", "require_cert", "[dom1]0")
modparam("tls_mgm", "tls_method", "[dom1]-")
modparam("tls_mgm", "certificate", "[dom1]/usr/local/etc/opensips/cert/cert.pem")
modparam("tls_mgm", "private_key", "[dom1]/usr/local/etc/opensips/cert/privkey.pem")
#modparam("tls_mgm", "match_sip_domain", "[dom1]uctenant1.ecosmob.net")
modparam("tls_mgm", "ca_list", "[dom1]/usr/local/etc/opensips/cert/fullchain.pem")


modparam("tls_mgm", "client_domain", "dom2")
modparam("tls_mgm", "verify_cert", "[dom2]0")
modparam("tls_mgm", "require_cert", "[dom2]0")
modparam("tls_mgm", "certificate", "[dom2]/usr/local/etc/opensips/cert/cert.pem")
modparam("tls_mgm", "private_key", "[dom2]/usr/local/etc/opensips/cert/privkey.pem")
#modparam("tls_mgm", "match_ip_address", "[dom2]*")
modparam("tls_mgm", "match_sip_domain", "[dom2]*")
modparam("tls_mgm", "ca_list", "[dom2]/usr/local/etc/opensips/cert/fullchain.pem")
modparam("tls_mgm", "tls_method", "[dom2]-")


#### Rabbitmq_consumer Module
loadmodule "rabbitmq_consumer.so"
#modparam("rabbitmq_consumer", "connection_id","uri = amqp://127.0.0.1; queue = IHA; event = event_msg;")
#modparam("rabbitmq_consumer", "connection_id","uri = amqp://127.0.0.1; queue = registrant; event = event_reg;")

#### Event route Module
loadmodule "event_route.so"

#### MAX ForWarD module
loadmodule "maxfwd.so"

####rtpengine module
loadmodule "rtpengine.so"
modparam("rtpengine", "rtpengine_sock","udp:72.60.40.106:22222")
modparam("rtpengine", "rtpengine_disable_tout", 60)
modparam("rtpengine", "rtpengine_retr", 5)

#### cfgutils module
loadmodule "cfgutils.so"

#### SIP MSG OPerationS module
loadmodule "sipmsgops.so"

#### FIFO Management Interface
loadmodule "mi_fifo.so"
modparam("mi_fifo", "fifo_name", "/tmp/opensips_fifo")
modparam("mi_fifo", "fifo_mode", 0666)

#### USeR LOCation module
loadmodule "usrloc.so"
#modparam("usrloc", "db_url", "mysql://megh_user:Gv9Xr2mQpLz7KbYt@72.60.40.106/ucdb")
modparam("usrloc", "db_mode", 0)
modparam("usrloc", "nat_bflag", "NAT")


loadmodule "nathelper.so"
modparam("nathelper", "natping_interval", 0)
#modparam("nathelper", "natping_interval", 60)
#modparam("nathelper", "ping_nated_only", 1)
modparam("nathelper", "received_avp", "$avp(received)")
#modparam("nathelper", "max_pings_lost", 3)
#modparam("nathelper", "sipping_from", "sip:devicepinger@72.60.40.106") # opensips ip needs to add
#modparam("nathelper", "natping_partitions", 4)
modparam("nathelper", "sipping_bflag", "SIPPING_ENABLE")
modparam("nathelper", "remove_on_timeout_bflag", "SIPPING_RTO")

#### Proto hep Module
loadmodule "proto_hep.so"
modparam("proto_hep", "hep_id", "[hid] 72.60.40.106:9060;transport=udp;version=3")
modparam("proto_hep", "hep_id", "[tid] 72.60.40.106:9060;transport=tcp;version=3")

#### Sip trace Module
loadmodule "tracer.so"
modparam("tracer", "trace_on", 1)
#modparam("tracer", "trace_id", "[tid]uri=hep:hid")
modparam("tracer", "trace_id", "[hid]uri=hep:tid")


#### REGISTRAR module
loadmodule "registrar.so"
modparam("registrar", "received_avp", "$avp(received)")

loadmodule "mid_registrar.so"
modparam ("mid_registrar", "mode", 1)
modparam("mid_registrar", "retry_after", 30)
modparam ("mid_registrar", "outgoing_expires",3600)
modparam ("mid_registrar", "received_avp", "$avp(received)")
modparam("mid_registrar", "extra_contact_params_avp", "$avp(extra_ct_params)")
#modparam("mid_registrar", "tcp_persistent_flag", "TCP_PERSIST_REGISTRATIONS")

loadmodule "uac_auth.so"
modparam("uac_auth","auth_username_avp","$avp(user)")
modparam("uac_auth","auth_password_avp","$avp(pass)")
modparam("uac_auth","auth_realm_avp","$avp(realm)")

loadmodule "uac_registrant.so"
modparam("uac_registrant", "db_url", "mysql://megh_user:Gv9Xr2mQpLz7KbYt@72.60.40.106/ucdb")
modparam("uac_registrant", "timer_interval", 60)

####### Routing Logic ########

# main request routing logic

route{
#       xlog("[$ci] [MAIN_ROUTE] [$rm] Main route\n");
        t_check_trans();
/*
        if(is_method("SUBSCRIBE|PUBLISH|NOTIFY")) {
                send_reply(503,"Method Not Implemented");
                exit;
        }
*/
        route(SANITY_CHECKS);
        route(PROCESS_OPTIONS);
        route(NAT_HANDLE);
        route(PRESENCE);
        route(WITHIN_DIALOG);
        if (is_method("CANCEL")) {
                if (t_check_trans())
                        t_relay();
                exit;
        }
        if (is_method("OPTIONS")){
                send_reply(200,"OK");
                exit;
        }
    if (is_method("ACK")) {
                route(PROCESS_ACK);
                exit;
        }
	
	if(is_method("INVITE")) {
		xlog("L_INFO", "[$ci] [$rm] INVITE FULL PACKET: [$mb] \n");
	}


        if (is_method("INVITE") && !has_totag()) {
                record_route();
                xlog("L_INFO", "---[MAIN] [$ci] [$rm] INITIAL INVITE CREATING DIALOG request domain : [$rd]  , to number : [$tU], From User : [$fU], Sorce ip and port : [$si:$sp] and full packet : [$mb]   \n");
                if ($socket_in(proto) == 'WS' || $socket_in(proto) == 'WSS'|| $socket_in(proto) == 'ws' ||  $socket_in(proto) == 'wss'){
                        setflag("SRC_WS");
                        xlog("L_INFO","[$ci][MAIN ROUTE] [$rm] [SOURCE_PROTO] [WSS]  \n") ;
                }
                create_dialog("B");
        }

        route(AUTHENTICATION);
        route(RELAY);
}

route[SANITY_CHECKS] {
    if (!mf_process_maxfwd_header(10)) {
                send_reply(483,"Too Many Hops");
                xlog("483 from US");
                exit;
        }
}

route[NAT_HANDLE] {
        force_rport();
        if (nat_uac_test("private-contact,diff-ip-src-via,private-via,diff-port-src-via")) {
#        xlog("L_INFO", "LOG: we have a NAT");
                if (is_method("REGISTER")) {
                        xlog("REGISTER BEHIND NAT from user : [$fU] \n");
                        fix_nated_register();
                        setbflag("NAT");
                        setbflag("SIPPING_ENABLE");
                        setbflag("SIPPING_RTO");
                } else {
                        xlog("L_INFO", "[$ci] [NAT_HANDLE] contact changed source ip : [$si:$sp] - [$rm] and full packet : [$mb] \n");
                        fix_nated_contact();
                        if(has_body("application/sdp")) {

                                xlog("L_INFO","[$ci][NAT_HANDLE] [$rm] [$rs] FIX NATED SDP Fucntion \n");
                                /*
                                   if(fix_nated_sdp("rewrite-origin-ip")){
                                   xlog("L_INFO","[$ci][NAT_HANDLE] [$rm] [$rs] FIX NATED SDP Fucntion \n");
                                   }
                                 */

                        }
                }
        }
}

event_route[event_reg]
{
        $avp(event_reg) = $param(1);
        xlog("L_INFO","[$ci] [$rm] Received RabbitMQ message [$param(1)]\n");
        exec("$avp(event)");
}

route[PROCESS_OPTIONS]{

        if(is_method("OPTIONS")) {
                if ( $si == "72.60.40.106") {
                        if (mid_registrar_lookup("location")) {
                                xlog("L_INFO","[PROCESS_OPTIONS] [$rm] COMING FROM SOURCE IP: [$si], Authenticated User : [$rU] is REGISTERED \n");
                                sl_send_reply(200,"OK");
                                exit;
                        }
                        else {
                                xlog("L_ERR","[PROCESS_OPTIONS] [$rm] COMING FROM SOURCE IP: [$si] IS NOT Authenticated User: [$rU] is not REGISTERED \n");
                                append_to_reply("Reason : User Not Registered\r\n");
                                sl_send_reply(403,"FORBIDDEN");
                                exit;
                        }
                } else {
                        sl_send_reply(200,"OK");
                        exit;
                }
        }
}

route[PROCESS_CANCEL] {
        route(CHECK_TRANSACTION);
}

route[PROCESS_ACK] {
        xlog("L_INFO","[$ci]--- [PROCESS_ACK] IN PROCESS ACK ---");
        route(CHECK_TRANSACTION);
}

route[CHECK_TRANSACTION] {
        if (t_check_trans()) {
                t_relay();
        }
        exit;
}

route[PRESENCE]{
        if(is_method("SUBSCRIBE|PUBLISH")) {
                $var(rc1)= trace("hid", "m", "sip");
		xlog("L_INFO", "[PRESENCE] [$ci] [$rm] Return code of 333 Tracer function : [$var(rc1)] \n");
                if ($socket_in(proto)  == 'WS' || $socket_in(proto)  == 'WSS'|| $socket_in(proto)  == 'ws' ||  $socket_in(proto)  == 'wss'){
                xlog("L_INFO","[$ci] [$rm] [PRESENCE] WSS Request Forwarding to Freeswitch Server \n");
                $ru = "sip:72.60.40.106:5071";
                force_send_socket("udp:72.60.40.106:5060");
        }
        else{
                xlog("L_INFO","[$ci] [$rm] [PRESENCE] UDP-TCP-TLS Registration packet sending to other asterisk server request URI  : [$ru] and [$mb]\n");

                if($socket_in(proto) == "tls" || $socket_in(proto) == "TLS"){
                        $avp(extra_ct_params) = ";transport=tls";
                        if ($(ru{uri.transport}) == "tls" || $(ru{uri.transport}) == "TLS" ) {
                                xlog("L_INFO","The username of our uri has transport tls don't need to add \n");
                                $ru = "sip:72.60.40.106:5061";
                        }else {

                                xlog("L_INFO","The username of our uri has not transport so needs to add tls \n");
                                $ru = "sip:72.60.40.106:5061;transport=tls";
                        }
                        force_send_socket("tls:72.60.40.106:5063");
                } else if($socket_in(proto) == "tcp" || $socket_in(proto) == "TCP"){
                        $avp(extra_ct_params) = ";transport=tcp";
                        xlog("L_INFO", "[$ci] [PRESENCE] [$rm] packet forwarding to Freeswitch with [$socket_in(proto)] protocol \n");
                        $ru = "sip:72.60.40.106:5071";
                        force_send_socket("tcp:72.60.40.106:5060");
                } else if($socket_in(proto) == "udp" || $socket_in(proto) == "UDP"){
                        $avp(extra_ct_params) = ";transport=udp";
                        xlog("L_INFO", "[$ci] [PRESENCE] [$rm] packet forwarding to Freeswitch with [$socket_in(proto)] protocol \n");
                        $ru = "sip:72.60.40.106:5071";
                        force_send_socket("udp:72.60.40.106:5060");
                }
        }
                route(RELAY);
                exit;
        } else {
                	$var(rc1)= trace("hid", "m", "sip");
			xlog("L_INFO", "[PRESENCE] [$ci] [$rm] Return code of 111 Tracer function : [$var(rc1)] \n");
                	$var(rc2)= trace("hid", "d", "sip");
			xlog("L_INFO", "[PRESENCE] [$ci] [$rm] Return code of 222 Tracer function : [$var(rc2)] \n");
                if(is_method("NOTIFY")) {
                	$var(rc)= trace("hid", "t", "sip");
			xlog("L_INFO", "[PRESENCE] [$ci] [$rm] Return code of Tracer function : [$var(rc1)] \n");
                        if (!mid_registrar_lookup("location")) {
                                xlog("L_INFO","[$ci] [PRESENCE] [$rm] [LOOKUP-FAILED] Notify end user not found \n") ;
                                sl_send_reply(404, "Not Found");
                                exit;
                        } else {
                                xlog("L_INFO", " [$ci] [$rm] [PRESENCE] NOTIFY Routing To Destination: [$ru] \n");
                        }
                route(RELAY);
                exit;
                }
        }

}


route[WITHIN_DIALOG] {

        if (has_totag() && is_method("INVITE|ACK|BYE|UPDATE|REFER|PRACK|INFO|NOTIFY|OPTIONS")) {
                trace("hid", "t", "sip");
                #trace("tid", "t", "sip");
                if (loose_route()) {
                        if (is_method("INVITE")) {
# even if in most of the cases is useless, do RR for
# re-INVITEs alos, as some buggy clients do change route set
# during the dialog.
                                record_route();
                                $dlg_val(invite_direction)= $DLG_dir;
                                $avp(process_rtpengine_answer_within_dialog)='rtpanswerwithindialog';
                                route(RTPENGINE_OFFER_WITHIN_DIALOG);
                        }
                        if(is_method("BYE")) {
                                rtpengine_delete();
                        }

                        if (is_method("ACK")) {

                                xlog("--------- ACK RECEVIED with ru : [$ru ] ---------- source ip : [$si:$sp]\n");
                        }
                        route(RELAY);
                }

                if (is_method("ACK") && t_check_trans()) {
                        xlog("L_INFO","[$ci] [WITHIN_DIALOG] [$rm] detected with valid transaction - t_relay");
                        t_relay();
                        exit;
                }
                sl_send_reply(404,"Not here");
                exit;
        }
}

route [AUTHENTICATION] {
    trace("hid", "t", "sip");
    #trace("tid", "t", "sip");
    if(is_method("REGISTER")){
        route(REGISTER_ROUTE);
    } else if (is_method("INVITE")) {
        route(INVITE_ROUTE);
    }
}

route[REGISTER_ROUTE] {
        xlog("L_INFO","[$ci] [REGISTER_ROUTE] [$rm] forwarding REGISTER to main registrar (ci=$ci) \n");
        if(mid_registrar_save("location")) {
                $var(rc) = $retcode;
                xlog ("L_INFO","[REGISTER_ROUTE] [$rm] mid_registrar_save function Success with reference to returned code by last invoked function -> $rc   $retcode  $var(rc) ");
                if ($(var(rc){s.int}) == 2) {
                        xlog("L_INFO","[REGISTER_ROUTE] [$rm] Return Code : [$var(rc)] This REGISTER has been absorbed!\n");
                        drop();
                }
        }
	$avp(user) = $hdr(User-Agent);
	remove_hf("User-Agent");
	append_hf("User-Agent: $avp(user) ::client_ip=$si");
        if ($socket_in(proto)  == 'WS' || $socket_in(proto)  == 'WSS'|| $socket_in(proto)  == 'ws' ||  $socket_in(proto)  == 'wss'){
                xlog("L_INFO","[$ci] [$rm] [REGISTER_ROUTE] WS-WSS Registration packet sending to Asterisk server 1 \n");
                setflag("SRC_WS");
                if (isflagset("SRC_WS"))
                        setbflag("DST_WS");
                $ru = "sip:72.60.40.106:5071";
                force_send_socket("udp:72.60.40.106:5060");
        }
        else{
                xlog("L_INFO","[$ci] [$rm] [REGISTER_ROUTE] UDP-TCP-TLS Registration packet sending to other asterisk server request URI  : [$ru] and [$mb]\n");

                if($socket_in(proto) == "tls" || $socket_in(proto) == "TLS"){
                        $avp(extra_ct_params) = ";transport=tls";
                        if ($(ru{uri.transport}) == "tls" || $(ru{uri.transport}) == "TLS" ) {
                                xlog("L_INFO","The username of our uri has transport tls don't need to add 111111111 \n");
                                $ru = "sip:72.60.40.106:5061";
                        }else {

                                xlog("L_INFO","The username of our uri has not transport so needs to add tls 22222222 \n");
                                $ru = "sip:72.60.40.106:5061;transport=tls";
                        }
                        force_send_socket("tls:72.60.40.106:5063");
                } else if($socket_in(proto) == "tcp" || $socket_in(proto) == "TCP"){
                        $avp(extra_ct_params) = ";transport=tcp";
                        xlog("L_INFO", "[$ci] [REGISTER_ROUTE] [$rm] Register packet forwarding to Freeswitch with [$socket_in(proto)] protocol \n");
                        $ru = "sip:72.60.40.106:5071";
                        force_send_socket("tcp:72.60.40.106:5060");
                } else if($socket_in(proto) == "udp" || $socket_in(proto) == "UDP"){
                        $avp(extra_ct_params) = ";transport=udp";
                        xlog("L_INFO", "[$ci] [REGISTER_ROUTE] [$rm] Register packet forwarding to Freeswitch with [$socket_in(proto)] protocol \n");
                        $ru = "sip:72.60.40.106:5071";
                        force_send_socket("udp:72.60.40.106:5060");
                }
        }
        route(RELAY);
        exit;
}

route[INVITE_ROUTE] {
        xlog("L_INFO", "[$ci] [$rm] [INVITE_ROUTE] \n");
        if (check_source_address(1) && $si != "72.60.40.106") {
                xlog("L_INFO", "[$ci] [$rm] [INVITE_ROUTE] \n");

                        if($socket_in(proto) == "tls" || $socket_in(proto) == "TLS"){
                                        $ru = "sip:72.60.40.106:5081";
                                force_send_socket("udp:72.60.40.106:5060");
                        } else if($socket_in(proto) == "tcp" || $socket_in(proto) == "TCP"){
                                xlog("L_INFO", "[$ci] [INVITE_ROUTE] [$rm] INVITE Request Forwarding to Freeswitch proto: [$socket_in(proto)] \n");
                                $ru = "sip:72.60.40.106:5081";
                                force_send_socket("tcp:72.60.40.106:5060");
                        } else if($socket_in(proto) == "udp" || $socket_in(proto) == "UDP"){
                                xlog("L_INFO", "[$ci] [INVITE_ROUTE] [$rm] INVITE Request Forwarding to Freeswitch proto: [$socket_in(proto)] \n");
                                $ru = "sip:72.60.40.106:5081";
                                force_send_socket("udp:72.60.40.106:5060");
                        }
                route(RELAY);


        }else if ($si == "72.60.40.106" ||  $si == "72.60.40.106"){
        #if ($si == "72.60.40.106" && ( $sp == "5071" || $sp == "5081" )){

                xlog("L_INFO", "[$ci] [$rm] [INVITE_ROUTE] Call Coming From Freeswitch ...... \n");

                if (!mid_registrar_lookup("location")) {
                        if (is_myself("$td")) {
                                xlog("L_INFO","[$ci][LOCATION] [LOOKUP-FAILED] [DOMAIN IS LOCAL] [$td] ") ;
                                sl_send_reply(404, "Not Found");
                                exit;
                        } else {
                                $avp(to_header)= $(hdr(to){nameaddr.uri}) ;
                                $ru= $avp(to_header) ;
                                xlog("L_INFO", " [$ci] [$rm] [INVITE_ROUTE] Call Routing To Outbound Carrier : [$td]  \n");
                        }
                } else {
                        xlog("L_INFO", "[$ci] [$rm] [INVITE_ROUTE] LOG: Lookup (MIDREGISTRAR) is working , now forwarding to ru : [$ru] and du :[$du] \n");
                        if(isflagset("SRC_WS")) {
                                xlog("L_INFO","[$ci] [INVITE_ROUTE] [$rm] INVITE From FreeSWITCH and SRC flag is SET \n");
                        }
                        if (isflagset("SRC_WS") || $rP == 'WSS' || $rP == 'wss' || $rP == 'WS' || $rP == 'ws') {
                                xlog("L_INFO","[$ci] [INVITE_ROUTE] [$rm] SRC is WS and Destination is [$rP] [WSS] \n");
                                setbflag("DST_WS") ;
                        }

                }

                route(RELAY);
        }else {
                if ($socket_in(proto)  == 'WS' || $socket_in(proto)  == 'WSS'|| $socket_in(proto)  == 'ws' ||  $socket_in(proto)  == 'wss'){
                        xlog("if part WSS ru is $ru mb is $mb");
#$du="sip:137.184.2.92:65080";
                        $ru="sip:72.60.40.106:5071";
                        force_send_socket("udp:72.60.40.106:5060");
                        setflag("SRC_WS");
                }else{
                        if($socket_in(proto) == "tls" || $socket_in(proto) == "TLS"){
                                if ($(ru{uri.transport}) == "tls" || $(ru{uri.transport}) == "TLS" ) {
                                        xlog("L_INFO","The username of our uri has transport tls don't need to add \n");
                                        $ru = "sip:72.60.40.106:5061";
                                }else {

                                        $ru = "sip:72.60.40.106:5061;transport=tls";
                                }
                                force_send_socket("tls:72.60.40.106:5063");
                        } else if($socket_in(proto) == "tcp" || $socket_in(proto) == "TCP"){
                                xlog("L_INFO", "[$ci] [INVITE_ROUTE] [$rm] INVITE Request Forwarding to Freeswitch proto: [$socket_in(proto)] \n");
                                $ru = "sip:72.60.40.106:5071";
                                force_send_socket("tcp:72.60.40.106:5060");
                        } else if($socket_in(proto) == "udp" || $socket_in(proto) == "UDP"){
                                xlog("L_INFO", "[$ci] [INVITE_ROUTE] [$rm] INVITE Request Forwarding to Freeswitch proto: [$socket_in(proto)] \n");
                                $ru = "sip:72.60.40.106:5071";
                                force_send_socket("udp:72.60.40.106:5060");
                        }
                }
                route(RELAY);
        }
}



route[PROCESS_RTPENGINE_OFFER]{
        xlog("L_INFO", "[$ci] [$rm] RTPENGINE_OFFER  \n");
        if (isflagset("SRC_WS") && isbflagset("DST_WS")) { # WS to WS
                xlog("L_INFO", " [$ci] [PROCESS_RTPENGINE_OFFER] [$rm] 111111111111111 \n");
                $dlg_val(caller_offer_rtpengine_string) = "trust-address replace-origin replace-session-connection ICE=force-relay DTLS=passive generate-mid SDES-off";
                rtpengine_offer("trust-address replace-origin replace-session-connection ICE=force-relay DTLS=passive generate-mid SDES-off");

        } else if (isflagset("SRC_WS") && !isbflagset("DST_WS")) { # WS to UDP
                xlog("L_INFO", " [$ci] [PROCESS_RTPENGINE_OFFER] [$rm] 222222222222222 \n");
                $dlg_val(caller_offer_rtpengine_string) = "RTP/AVP ICE=remove trust-address replace-session-connection replace-origin rtcp-mux-demux DTLS=off generate-mid";
                rtpengine_offer("RTP/AVP ICE=remove trust-address replace-session-connection replace-origin rtcp-mux-demux DTLS=off generate-mid");

        } else if (!isflagset("SRC_WS") && isbflagset("DST_WS")) { #UDP to WS
                xlog("L_INFO", " [$ci] [PROCESS_RTPENGINE_OFFER] [$rm] 333333333333333 \n");
                $dlg_val(caller_offer_rtpengine_string)="UDP/TLS/RTP/SAVP ICE=force generate-mid replace-origin replace-session-connection SDES-off rtcp-mux-offer trust-address";
                #rtpengine_offer("UDP/TLS/RTP/SAVPF ICE=force");
                rtpengine_offer("UDP/TLS/RTP/SAVP trust-address ICE=force rtcp-mux-offer SDES-off replace-session-connection replace-origin generate-mid ");
                #rtpengine_offer("UDP/TLS/RTP/SAVP trust-address ICE=force rtcp-mux-offer SDES-off replace-session-connection replace-origin"); #working091123
                #rtpengine_offer("trust-address RTP/SAVPF ICE=force generate-mid replace-origin replace-session-connection SDES-off rtcp-mux-offer DTLS=passive"); # 301023
                #rtpengine_offer("UDP/TLS/RTP/SAVP ICE=force generate-mid replace-origin replace-session-connection SDES-off rtcp-mux-offer trust-address"); #26-10-23
                #rtpengine_offer("UDP/TLS/RTP/SAVPF ICE=force generate-mid DTLS=passive SDES-off rtcp-mux-offer");

        } else if (!isflagset("SRC_WS") && !isbflagset("DST_WS")) { #UDP to UDP
                xlog("L_INFO", " [$ci] [PROCESS_RTPENGINE_OFFER] [$rm] 444444444444444 \n");
                $dlg_val(caller_offer_rtpengine_string) = "trust-address replace-session-connection replace-origin rtcp-mux-demux ICE=remove";
                rtpengine_offer("trust-address rtcp-mux-demux replace-session-connection replace-origin ICE=remove");
        } else {

        xlog("1111111111111111111111111 offer else  \n");
        }
}

route[PROCESS_RTPENGINE_ANSWER]{
        xlog("L_INFO", "[$ci] [$rm] RTPENGINE_ANSWER \n");

        if (isflagset("SRC_WS") && isbflagset("DST_WS")){ # WS to WS
                $dlg_val(callee_answer_rtpengine_string) = "trust-address replace-origin replace-session-connection ICE=force  DTLS=passive SDES-off rtcp-mux-offer generate-mid";
                rtpengine_answer("replace-origin replace-session-connection ICE=force trust-address DTLS=passive SDES-off rtcp-mux-offer generate-mid");
                xlog("L_INFO","11111111111111111 [$ci]---[PROCESS_RTPENGINE_ANSWER]  [FLAG-RTP-SET] [SRC_WS] [DST_WS]  \n");
        } else if (isflagset("SRC_WS") && !isbflagset("DST_WS")){ # WS to UDP
                $dlg_val(callee_answer_rtpengine_string) = "trust-address replace-origin replace-session-connection RTP/SAVPF ICE=force DTLS=passive SDES-off rtcp-mux-offer generate-mid";
                rtpengine_answer("trust-address replace-origin replace-session-connection RTP/SAVPF ICE=force DTLS=passive SDES-off rtcp-mux-offer generate-mid");
                xlog("L_INFO","222222222222222 [$ci]---[PROCESS_RTPENGINE_ANSWER]  [FLAG-RTP-SET] [SRC_WS] \n");
        }else if (!isflagset("SRC_WS") && isbflagset("DST_WS")){ # UDP to WS
                $dlg_val(callee_answer_rtpengine_string) = "RTP/AVP DTLS=passive trust-address replace-session-connection replace-origin ICE=remove";
                rtpengine_answer("DTLS=passive rtcp-mux-demux ICE=remove RTP/AVP trust-address replace-session-connection replace-origin");
                #rtpengine_answer("replace-origin replace-session-connection ICE=remove RTP/AVP trust-address rtcp-mux-demux DTLS=off generate-mid");
                #rtpengine_answer("trust-address replace-origin replace-session-connection rtcp-mux-demux generate-mid ICE=remove SDEC-off RTP/AVP");
                #rtpengine_answer("trust-address replace-origin replace-session-connection rtcp-mux-offer generate-mid ICE=force SDEC-off RTP/SAVP DTLS=passive");
                xlog("L_INFO","333333333333333 [$ci]---[PROCESS_RTPENGINE_ANSWER]  [FLAG-RTP-SET] [DST_WS] \n");
        }else if (!isflagset("SRC_WS") && !isbflagset("DST_WS")){ # UDP to UDP
                $dlg_val(callee_answer_rtpengine_string) = "trust-address replace-session-connection replace-origin rtcp-mux-demux ICE=remove";
                rtpengine_answer("replace-session-connection replace-origin rtcp-mux-demux ICE=remove in-iface=internal out-iface=external");
                #rtpengine_answer("RTP/AVP trust_address replace-session-connection replace-origin ICE=remove");
                xlog("L_INFO","4444444444444444 [$ci]---[PROCESS_RTPENGINE_ANSWER]  [FLAG-RTP-SET] \n");
        }
}


route[RTPENGINE_OFFER_WITHIN_DIALOG]{
        xlog("L_INFO","[$ci] [RTPENGINE_OFFER_WITHIN_DIALOG] [$dlg_val(caller_offer_rtpengine_string)] [RTPENGINE_ANSWER]: [$dlg_val(callee_answer_rtpengine_string)]") ;
        if($DLG_dir=='downstream' || $DLG_dir=='DOWNSTREAM') {
                $var(caller_offer_rtpengine_string) =$dlg_val(caller_offer_rtpengine_string) ;
                xlog("L_INFO","11111 [$ci] [RTPENGINE_OFFER_WITHIN_DIALOG] [RE-INVTE COMES FROM CALLER] param: [$var(caller_offer_rtpengine_string)]\n");
                rtpengine_offer("$var(caller_offer_rtpengine_string)");
        }else if($DLG_dir=='upstream' || $DLG_dir=='UPSTREAM'){
                $var(callee_answer_rtpengine_string)= $dlg_val(callee_answer_rtpengine_string) ;
                xlog("L_INFO","1111111 [$ci] [RTPENGINE_OFFER_WITHIN_DIALOG] [RE-INVTE COMES FROM CALLEE] param: [$var(callee_answer_rtpengine_string)]\n");
                rtpengine_offer("$var(callee_answer_rtpengine_string)");
        }

        xlog("L_INFO","[$ci] [RTPENGINE_OFFER_WITHIN_DIALOG] [RE-IVITE DIRECTION] [$dlg_val(invite_direction)]") ;
}

route[RTPENGINE_ANSWER_WITHIN_DIALOG]{
        xlog("L_INFO","[$ci] [RTPENGINE_ANSWER_WITHIN_DIALOG]");
        xlog("L_INFO","[$ci] [RTPENGINE_ANSWER_WITHIN_DIALOG] [$dlg_val(caller_offer_rtpengine_string)] [RTPENGINE_ANSWER]: [$dlg_val(callee_answer_rtpengine_string)]") ;

        if($dlg_val(invite_direction)=='downstream' || $dlg_val(invite_direction)=='DOWNSTREAM') {
                xlog("L_INFO","1111111111111 [$ci] [RTPENGINE_ANSWER_WITHIN_DIALOG] [200-OK COMES FROM CALLEE] [$dlg_val(callee_answer_rtpengine_string)] [UPSTREAM] \n");
                $var(callee_answer_rtpengine_string) =$dlg_val(callee_answer_rtpengine_string) ;

                rtpengine_answer("$var(callee_answer_rtpengine_string)");

        }else if( $dlg_val(invite_direction)=='upstream' || $dlg_val(invite_direction)=='UPSTREAM'){
                xlog("L_INFO","111111111111111111111 [$ci] [RTPENGINE_ANSWER_WITHIN_DIALOG] [200-OK COMES FROM CALLER] [$dlg_val(caller_offer_rtpengine_string)] [DOWNSTREAM] \n");
                $var(caller_offer_rtpengine_string)=$dlg_val(caller_offer_rtpengine_string) ;
                rtpengine_answer("$var(caller_offer_rtpengine_string)");
        }
}

route[RELAY] {
# for INVITEs enable some additional helper routes

        if (is_method("INVITE") && has_body("application/sdp") && !has_totag()){
                xlog("L_INFO","[$ci] [RELAY] [$rm] [CALLING RTP OFFER ROUTE]  FULL PACKET : [$mb]\n");
                t_on_branch("RTP_OFFER");
        }


        if (is_method("INVITE|REGISTER")) {
        #       t_on_branch("DEFAULT_BRANCH_ROUTE");
                t_on_reply("DEFAULT_REPLY_ROUTE");
                t_on_failure("DEFAULT_FAILURE_ROUTE");
        }

        if (!t_relay()) {
                sl_reply_error();
        }
        exit;
}


branch_route[RTP_OFFER]{
        xlog("L_INFO","[$ci][BRANCH_ROUTE] [RTP_OFFER]");
        route(PROCESS_RTPENGINE_OFFER);
}


onreply_route[DEFAULT_REPLY_ROUTE] {
        xlog("L_INFO", "[$ci] [DEFAULT_REPLY_ROUTE] [$rm] source ip: [$si] and port: [$sp] incoming reply : [$rs] \n");
        if(is_method("REGISTER")){
                xlog("L_INFO", "[$ci] [DEFAULT_REPLY_ROUTE] [$rm] Method is Register  \n");
                if(t_check_status("200")) {
        #               if (isflagset("SRC_WS"))
          #                      setbflag("DST_WS");
         #              $var(rc) = save("location");
                        xlog("L_INFO","[$ci] [DEFAULT_REPLY_ROUTE] [$rm] User Register status : [$var(rc)] \n");
                }
        }
        if ($(ct.fields(uri){uri.host}) == "72.60.40.106" || $(ct.fields(uri){uri.host}) == "72.60.40.106" && t_check_status("200") ) {
                        xlog("L_INFO","[$ci][DEFAULT_REPLY_ROUTE] METHOD: [$rm] [$rs] $Ts , $Tsm , $TS Response Coming From Freeswitch Source Ip : [$(ct.fields(uri){uri.host})], Freeswitch : [FREESWITCH_IP] ");
        } else {
                xlog("L_INFO", "[DEFAULT_REPLY_ROUTE] [$rs] with nat handle  \n ");
                route(NAT_HANDLE);
        }
        if(has_body("application/sdp")) {
                xlog("L_INFO"," [$ci] [DEFAULT_REPLY_ROUTE] [$rm] Caling RTPENGINE_ANSWER Route \n");
                if(!is_avp_set("$avp(process_rtpengine_answer_within_dialog)")){
                xlog("L_INFO","[$ci] [DEFAULT_REPLY_ROUTE] [$rm] RTPENGINE_ANSWER route calling \n");
                        route(PROCESS_RTPENGINE_ANSWER);
                } else {
                        route(RTPENGINE_ANSWER_WITHIN_DIALOG);
                        xlog("L_INFO","[$ci] [DEFAULT_REPLY_ROUTE] [$rm] RTPENGINE_ANSWER_WITHIN_DIALOG route calling \n");
                }
        }
}


failure_route[DEFAULT_FAILURE_ROUTE] {
        xlog("L_INFO", " [$ci] [DEFAULT_FAILURE_ROUTE] [$rm] Failure route \n");
        if (t_was_cancelled()) {
                exit;
        }

}

